clear;close all;clc

tic
c0 = 340;
rho0 = 1.225;

nx = [0 0 1 1 0 1 0 2 2 1]';
ny = [0 1 0 1 2 2 3 0 1 3]';

lx = 0.1; % Cavity height [m]
ly = 0.2;  % Cavity width  [m]
lz = 0.15; % Cavity depth  [m]

% fn = c0/2 .* sqrt((nx./lx).^2 + (ny./ly).^2); % Modal frequencies of infinite long rect duct

theta = 0;
varphi = 0;

s = [0.35 0.20 -0.35]; % SOURCE (point monopole)
r = [0.10 0.20 0.30];  % RECEIVER (SPL measurement)



% f = [100, 103, 106, 109, 112, 115, 118, 122, 125, 128, 132, 136, 140, 145, 150, 155, 160, 165, 170, 175, 180, 185, 190, 195, 200, 206, 212, 218, 224, 230, 236, 243, 250, 258, 265, 272, 280, 290, 300, 307, 315, 325, 335, 345, 355, 365, 375, 387, 400, 412, 425, 437, 450, 462, 475, 487, 500, 515, 530, 545, 560, 580, 600, 615, 630, 650, 670, 690, 710, 730, 750, 775, 800, 825, 850, 875, 900, 925, 950, 975, 1e3, 1.03e3, 1.06e3, 1.09e3, 1.12e3, 1.15e3, 1.18e3, 1.22e3, 1.25e3, 1.28e3, 1.32e3, 1.36e3, 1.4e3, 1.45e3, 1.5e3, 1.55e3, 1.6e3, 1.65e3, 1.7e3, 1.75e3, 1.8e3, 1.85e3, 1.9e3, 1.95e3, 2e3, 2.06e3, 2.12e3, 2.18e3, 2.24e3, 2.3e3, 2.36e3, 2.43e3, 2.5e3, 2.58e3, 2.65e3, 2.72e3, 2.8e3, 2.9e3, 3e3, 3.07e3, 3.15e3, 3.25e3, 3.35e3, 3.45e3, 3.55e3, 3.65e3, 3.75e3, 3.87e3, 4e3, 4.12e3, 4.25e3, 4.37e3, 4.5e3, 4.62e3, 4.75e3, 4.87e3, 5e3];
f = [50, 51.5, 53, 54.5, 56, 58, 60, 61.5, 63, 65, 67, 69, 71, 73, 75, 77.5, 80, 82.5, 85, 87.5, 90, 92.5, 95, 97.5, 100, 103, 106, 109, 112, 115, 118, 122, 125, 128, 132, 136, 140, 145, 150, 155, 160, 165, 170, 175, 180, 185, 190, 195, 200, 206, 212, 218, 224, 230, 236, 243, 250, 258, 265, 272, 280, 290, 300, 307, 315, 325, 335, 345, 355, 365, 375, 387, 400, 412, 425, 437, 450, 462, 475, 487, 500, 515, 530, 545, 560, 580, 600, 615, 630, 650, 670, 690, 710, 730, 750, 775, 800, 825, 850, 875, 900, 925, 950, 975, 1e3, 1.03e3, 1.06e3, 1.09e3, 1.12e3, 1.15e3, 1.18e3, 1.22e3, 1.25e3, 1.28e3, 1.32e3, 1.36e3, 1.4e3, 1.45e3, 1.5e3, 1.55e3, 1.6e3, 1.65e3, 1.7e3, 1.75e3, 1.8e3, 1.85e3, 1.9e3, 1.95e3, 2e3, 2.06e3, 2.12e3, 2.18e3, 2.24e3, 2.3e3, 2.36e3, 2.43e3, 2.5e3, 2.58e3, 2.65e3, 2.72e3, 2.8e3, 2.9e3, 3e3, 3.07e3, 3.15e3, 3.25e3, 3.35e3, 3.45e3, 3.55e3, 3.65e3, 3.75e3, 3.87e3, 4e3, 4.12e3, 4.25e3, 4.37e3, 4.5e3, 4.62e3, 4.75e3, 4.87e3, 5e3, 5.15e3, 5.3e3, 5.45e3, 5.6e3, 5.8e3, 6e3, 6.15e3, 6.3e3, 6.5e3, 6.7e3, 6.9e3, 7.1e3, 7.3e3, 7.5e3, 7.75e3, 8e3];
w = 2*pi*f;
k = w./c0;
S = lx*ly;

A = 10^-4; %amplitude ?
q0 = 10^-4; % strength







%% Full analytical model considering n modes
%%- Eq. 17


k_x = k.*sin(theta).*cos(varphi); % (1)
k_y = k.*sin(theta).*sin(varphi);
k_z = k.*cos(varphi);

% phi = phi_n(x,y,nx,ny,lx,ly); % (5)


n=1;
k_nz = sqrt(k.^2 - (nx(n).*pi./lx).^2 - (ny(n).*pi./ly).^2); % (6) 




G_B = @(x1, y1, x2, y2) ...
    phi_n(x1,y1,nx,ny,lx,ly)*(exp(-1i*ki*sqrt((x1-x2).^2 + (y1-y2).^2)) ./ 2*pi*sqrt((x1-x2).^2 + (y1-y2).^2 + eps) + ...
     exp(-1i*ki*sqrt((x1+x2).^2 + (y1-y2).^2)) ./ 2*pi*sqrt((x1+x2).^2 + (y1-y2).^2 + eps))* phi_n(x2,y2,nx,ny,lx,ly); % (11)

   intg = integralN(G_B,0, lx, 0, ly, 0, lx, 0, ly,'AbsTol',1e-5,'RelTol',1e-3);
   
   Znm = 1i*k/S * intg; % (10)






Lambda_n = zeros(size(nx)); % (12)
    % Case 1: nx = 0 and ny = 0
    Lambda_n(nx == 0 & ny == 0) = 1;
    % Case 2: nx = 0, ny ~= 0 OR nx ~= 0, ny = 0
    Lambda_n((nx == 0 & ny ~= 0) | (nx ~= 0 & ny == 0)) = 1/2;
    % Case 3: nx ~= 0 and ny ~= 0
    Lambda_n(nx ~= 0 & ny ~= 0) = 1/4;


W2 = S./(2.*rho0.*w) .* real(); % (17)

W1 = abs(A)^2*S*cos(theta) / (2*rho0*c0); % (18)

TLg_an_m = -10*log10(W2./W1); % (19)





function phi_ = phi_n(x,y,nx,ny,lx,ly)
    phi_ = cos(nx.*pi./lx .*x).*cos(ny.*pi./ly .*y);
end

